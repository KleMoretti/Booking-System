# 车次模板导入功能说明

## 功能概述

车次模板管理功能允许管理员通过 Excel 文件批量导入车次模板，方便快速创建和管理车次信息。

## 主要功能

1. **Excel 导入**: 支持上传.xlsx 或.xls 格式的 Excel 文件
2. **模板下载**: 提供标准的 Excel 模板下载
3. **数据验证**: 自动验证导入数据的完整性和正确性
4. **批量处理**: 支持一次导入多条车次模板
5. **查询管理**: 查看所有已导入的车次模板
6. **删除管理**: 可删除不需要的模板

## Excel 模板格式

### 列说明

| 列名     | 说明                           | 示例       | 必填 |
| -------- | ------------------------------ | ---------- | ---- |
| 车次号   | 车次编号，必须唯一             | G1001      | 是   |
| 车辆信息 | 车辆型号                       | CRH380A    | 否   |
| 总座位数 | 该车次总座位数                 | 556        | 是   |
| 出发站   | 出发站名称（必须在系统中存在） | 北京南站   | 是   |
| 到达站   | 到达站名称（必须在系统中存在） | 上海虹桥站 | 是   |
| 出发时间 | 格式: HH:mm                    | 08:00      | 是   |
| 到达时间 | 格式: HH:mm                    | 12:28      | 是   |
| 基础票价 | 票价金额（元）                 | 553.5      | 是   |

### 示例数据

```
车次号    车辆信息   总座位数   出发站      到达站        出发时间  到达时间  基础票价
G1001    CRH380A   556      北京南站    上海虹桥站     08:00    12:28    553.5
D2001    CRH2A     613      广州南站    深圳北站       09:30    10:15    79.5
G2002    CRH380BL  556      上海虹桥站  北京南站       13:00    17:28    553.5
```

## 使用步骤

### 1. 下载模板

1. 登录管理后台
2. 进入"车次模板管理"
3. 点击"下载模板"按钮
4. 获得标准 Excel 模板文件

### 2. 填写数据

1. 在 Excel 模板中填写车次信息
2. 确保所有必填字段都已填写
3. 检查站点名称是否在系统中存在
4. 确保时间格式正确（HH:mm）

### 3. 导入文件

1. 点击"导入 Excel"按钮
2. 选择填写好的 Excel 文件
3. 等待系统处理
4. 查看导入结果

### 4. 查看结果

- **成功**: 显示成功导入的记录数
- **失败**: 显示失败的记录数和具体错误信息
- **混合**: 部分成功时会显示详细的成功/失败统计

## 注意事项

### 数据验证规则

1. **车次号唯一性**: 同一车次号不能重复导入
2. **站点存在性**: 出发站和到达站必须在系统中已存在
3. **时间格式**: 必须使用 24 小时制 HH:mm 格式
4. **数值有效性**: 座位数和票价必须为正数

### 常见错误及解决方法

1. **"出发站 'xxx' 不存在"**

   - 解决: 先在站点管理中添加该站点

2. **"车次号已存在"**

   - 解决: 修改车次号或删除已存在的模板

3. **"时间格式错误"**

   - 解决: 使用 HH:mm 格式，如 08:30 而不是 8:30 AM

4. **"文件格式不支持"**
   - 解决: 确保文件为.xlsx 或.xls 格式

## 数据库表结构

```sql
CREATE TABLE IF NOT EXISTS trip_templates (
    template_id          INT PRIMARY KEY AUTO_INCREMENT,
    trip_number          VARCHAR(50)  NOT NULL,
    vehicle_info         VARCHAR(100),
    total_seats          INT          NOT NULL DEFAULT 0,
    departure_station_id INT          NOT NULL,
    arrival_station_id   INT          NOT NULL,
    departure_time       TIME         NOT NULL,
    arrival_time         TIME         NOT NULL,
    base_price           DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    is_active            TINYINT      DEFAULT 1,
    create_time          DATETIME     DEFAULT CURRENT_TIMESTAMP,
    update_time          DATETIME     DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## API 接口

### 1. 导入 Excel

- **URL**: `/api/admin/trip-templates/import`
- **Method**: POST
- **Content-Type**: multipart/form-data
- **参数**: file (Excel 文件)
- **返回**:

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "successCount": 10,
    "failCount": 2,
    "errors": ["第3行: 出发站不存在", "第5行: 车次号已存在"]
  }
}
```

### 2. 查询所有模板

- **URL**: `/api/admin/trip-templates/list`
- **Method**: GET
- **返回**: 模板列表

### 3. 删除模板

- **URL**: `/api/admin/trip-templates/{id}`
- **Method**: DELETE
- **参数**: id (模板 ID)

## 技术实现

### 后端技术栈

- Spring Boot
- MyBatis
- EasyExcel (Excel 处理)
- MySQL

### 前端技术栈

- React
- Ant Design
- Axios

### 核心代码文件

- **实体类**: `TripTemplate.java`
- **Mapper**: `TripTemplateMapper.java`, `TripTemplateMapper.xml`
- **Service**: `TripTemplateService.java`, `TripTemplateServiceImpl.java`
- **Controller**: `TripTemplateController.java`
- **前端组件**: `TripTemplateManagement.jsx`
- **API**: `tripTemplate.js`

## 部署说明

### 1. 数据库初始化

```bash
mysql -u root -p booking_system < trip_template_schema.sql
```

### 2. 后端部署

```bash
cd booking-system-backend
mvn clean package
java -jar target/booking-system-backend-1.0.0.jar
```

### 3. 前端部署

```bash
cd booking-system-frontend
npm install
npm run dev
```

## 测试建议

### 单元测试

1. 测试 Excel 解析功能
2. 测试数据验证逻辑
3. 测试数据库插入操作

### 集成测试

1. 上传有效的 Excel 文件
2. 上传包含错误的 Excel 文件
3. 测试重复车次号的处理
4. 测试不存在站点的处理

### 性能测试

- 测试批量导入 1000+条记录的性能
- 测试并发上传的处理能力

## 后续优化建议

1. **增强功能**

   - 支持模板编辑功能
   - 支持批量启用/禁用
   - 支持导出为 Excel
   - 支持模板复制

2. **性能优化**

   - 大文件分批处理
   - 异步导入处理
   - 导入进度提示

3. **用户体验**
   - 实时验证提示
   - 更详细的错误信息
   - 导入历史记录

## 联系支持

如有问题，请查看项目文档或联系开发团队。
