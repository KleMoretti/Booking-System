<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booking.mapper.OrderMapper">
    <!-- 订单相关SQL映射 -->

    <resultMap id="OrderResultMap" type="com.booking.entity.Order">
        <id property="orderId" column="order_id" />
        <result property="orderNumber" column="order_number" />
        <result property="userId" column="user_id" />
        <result property="totalAmount" column="total_amount" />
        <result property="paidAmount" column="paid_amount" />
        <result property="orderStatus" column="order_status" />
        <result property="createTime" column="create_time" />
        <result property="payTime" column="pay_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <insert id="insert" parameterType="com.booking.entity.Order" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO orders(order_number, user_id, total_amount, paid_amount, order_status)
        VALUES(#{orderNumber}, #{userId}, #{totalAmount}, #{paidAmount}, #{orderStatus})
    </insert>

    <update id="update" parameterType="com.booking.entity.Order">
        UPDATE orders
        SET total_amount = #{totalAmount},
            paid_amount = #{paidAmount},
            order_status = #{orderStatus},
            pay_time = #{payTime},
            update_time = NOW()
        WHERE order_id = #{orderId}
    </update>

    <select id="findById" parameterType="long" resultMap="OrderResultMap">
        SELECT * FROM orders WHERE order_id = #{orderId}
    </select>

    <select id="findByOrderNumber" parameterType="string" resultMap="OrderResultMap">
        SELECT * FROM orders WHERE order_number = #{orderNumber}
    </select>

    <select id="findByUserId" parameterType="int" resultMap="OrderResultMap">
        SELECT * FROM orders WHERE user_id = #{userId} ORDER BY create_time DESC
    </select>
    
    <!-- OrderVO结果映射 -->
    <resultMap id="OrderVOResultMap" type="com.booking.dto.OrderVO">
        <id property="orderId" column="order_id" />
        <result property="orderNumber" column="order_number" />
        <result property="totalAmount" column="total_amount" />
        <result property="paidAmount" column="paid_amount" />
        <result property="orderStatus" column="order_status" />
        <result property="createTime" column="create_time" />
        <result property="payTime" column="pay_time" />
        <result property="tripNumber" column="trip_number" />
        <result property="departureStation" column="departure_station" />
        <result property="arrivalStation" column="arrival_station" />
        <result property="departureTime" column="departure_time" />
        <result property="arrivalTime" column="arrival_time" />
        <collection property="tickets" ofType="com.booking.dto.OrderVO$TicketInfo">
            <id property="ticketId" column="ticket_id" />
            <result property="passengerName" column="passenger_name" />
            <result property="passengerIdCard" column="passenger_id_card" />
            <result property="seatNumber" column="seat_number" />
            <result property="price" column="actual_price" />
            <result property="ticketStatus" column="ticket_status" />
        </collection>
    </resultMap>
    
    <!-- 获取订单详情 -->
    <select id="getOrderDetail" parameterType="long" resultMap="OrderVOResultMap">
        SELECT 
            o.order_id,
            o.order_number,
            o.total_amount,
            o.paid_amount,
            o.order_status,
            o.create_time,
            o.pay_time,
            t.trip_number,
            ds.station_name AS departure_station,
            ars.station_name AS arrival_station,
            t.departure_time,
            t.arrival_time,
            tk.ticket_id,
            tk.passenger_name,
            tk.passenger_id_card,
            s.seat_number,
            tk.actual_price,
            tk.ticket_status
        FROM orders o
        LEFT JOIN tickets tk ON o.order_id = tk.order_id
        LEFT JOIN trips t ON tk.trip_id = t.trip_id
        LEFT JOIN stations ds ON t.departure_station_id = ds.station_id
        LEFT JOIN stations ars ON t.arrival_station_id = ars.station_id
        LEFT JOIN seats s ON tk.seat_id = s.seat_id
        WHERE o.order_id = #{orderId}
    </select>
    
    <!-- 统计今日订单数量 -->
    <select id="countTodayOrders" resultType="long">
        SELECT COUNT(*) FROM orders
        WHERE DATE(create_time) = CURDATE()
    </select>
</mapper>
