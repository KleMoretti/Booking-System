<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booking.mapper.TripMapper">
    <resultMap id="TripResultMap" type="com.booking.entity.Trip">
        <id property="tripId" column="trip_id" />
        <result property="tripNumber" column="trip_number" />
        <result property="vehicleInfo" column="vehicle_info" />
        <result property="totalSeats" column="total_seats" />
        <result property="departureStationId" column="departure_station_id" />
        <result property="arrivalStationId" column="arrival_station_id" />
        <result property="departureTime" column="departure_time" />
        <result property="arrivalTime" column="arrival_time" />
        <result property="basePrice" column="base_price" />
        <result property="tripStatus" column="trip_status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <insert id="insert" parameterType="com.booking.entity.Trip" useGeneratedKeys="true" keyProperty="tripId">
        INSERT INTO trips(trip_number, vehicle_info, total_seats, departure_station_id, arrival_station_id, departure_time, arrival_time, base_price, trip_status)
        VALUES(#{tripNumber}, #{vehicleInfo}, #{totalSeats}, #{departureStationId}, #{arrivalStationId}, #{departureTime}, #{arrivalTime}, #{basePrice}, #{tripStatus})
    </insert>

    <update id="update" parameterType="com.booking.entity.Trip">
        UPDATE trips
        SET trip_number = #{tripNumber},
            vehicle_info = #{vehicleInfo},
            total_seats = #{totalSeats},
            departure_station_id = #{departureStationId},
            arrival_station_id = #{arrivalStationId},
            departure_time = #{departureTime},
            arrival_time = #{arrivalTime},
            base_price = #{basePrice},
            trip_status = #{tripStatus},
            update_time = NOW()
        WHERE trip_id = #{tripId}
    </update>

    <select id="findById" parameterType="int" resultMap="TripResultMap">
        SELECT * FROM trips WHERE trip_id = #{tripId}
    </select>

    <resultMap id="TripVOResultMap" type="com.booking.dto.TripVO">
        <id property="tripId" column="trip_id" />
        <result property="tripNumber" column="trip_number" />
        <result property="departureStationName" column="departure_station_name" />
        <result property="arrivalStationName" column="arrival_station_name" />
        <result property="departureTime" column="departure_time" />
        <result property="arrivalTime" column="arrival_time" />
        <result property="duration" column="duration" />
        <association property="seatInfo" javaType="com.booking.dto.TripVO$SeatInfo">
            <result property="available" column="available_seats" />
            <result property="price" column="base_price" />
        </association>
    </resultMap>
    
    <select id="searchTrips" resultMap="TripVOResultMap">
        SELECT 
            t.trip_id,
            t.trip_number,
            ds.station_name AS departure_station_name,
            arr_station.station_name AS arrival_station_name,
            t.departure_time,
            t.arrival_time,
            CONCAT(
                FLOOR(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time) / 60), '小时',
                IF(MOD(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time), 60) > 0,
                   CONCAT(MOD(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time), 60), '分'),
                   '')
            ) AS duration,
            (t.total_seats - COALESCE((SELECT COUNT(*) FROM seats s WHERE s.trip_id = t.trip_id AND s.seat_status IN (1, 2)), 0)) AS available_seats,
            t.base_price
        FROM trips t
        LEFT JOIN stations ds ON t.departure_station_id = ds.station_id
        LEFT JOIN stations arr_station ON t.arrival_station_id = arr_station.station_id
        <where>
            <if test="departureStationId != null">
                AND t.departure_station_id = #{departureStationId}
            </if>
            <if test="arrivalStationId != null">
                AND t.arrival_station_id = #{arrivalStationId}
            </if>
            <if test="departureTimeFrom != null">
                AND t.departure_time &gt;= #{departureTimeFrom}
            </if>
            <if test="departureTimeTo != null">
                AND t.departure_time &lt;= #{departureTimeTo}
            </if>
        </where>
        ORDER BY t.departure_time ASC
    </select>

    <delete id="delete" parameterType="int">
        DELETE FROM trips WHERE trip_id = #{tripId}
    </delete>

    <!-- 统计车次数量 -->
    <select id="countTrips" resultType="long">
        SELECT COUNT(*) FROM trips
        <where>
            <if test="tripNumber != null and tripNumber != ''">
                AND trip_number LIKE CONCAT('%', #{tripNumber}, '%')
            </if>
        </where>
    </select>

    <!-- 更新车次票价 -->
    <update id="updatePrice">
        UPDATE trips SET base_price = #{basePrice}, update_time = NOW()
        WHERE trip_id = #{tripId}
    </update>

    <!-- 车次管理视图对象的结果映射 -->
    <resultMap id="TripManagementVOResultMap" type="com.booking.dto.TripManagementVO">
        <id property="tripId" column="trip_id" />
        <result property="tripNumber" column="trip_number" />
        <result property="vehicleInfo" column="vehicle_info" />
        <result property="departureStationName" column="departure_station_name" />
        <result property="arrivalStationName" column="arrival_station_name" />
        <result property="date" column="trip_date" />
        <result property="departureTime" column="departure_time_only" />
        <result property="arrivalTime" column="arrival_time_only" />
        <result property="duration" column="duration" />
        <association property="seats" javaType="com.booking.dto.TripManagementVO$SeatInfo">
            <result property="available" column="available_seats" />
            <result property="total" column="total_seats" />
            <result property="price" column="base_price" />
        </association>
    </resultMap>

    <!-- 管理端车次列表查询 -->
    <select id="getTripList" resultMap="TripManagementVOResultMap">
        SELECT 
            t.trip_id,
            t.trip_number,
            t.vehicle_info,
            ds.station_name AS departure_station_name,
            arr_station.station_name AS arrival_station_name,
            DATE_FORMAT(t.departure_time, '%Y-%m-%d') AS trip_date,
            DATE_FORMAT(t.departure_time, '%H:%i') AS departure_time_only,
            DATE_FORMAT(t.arrival_time, '%H:%i') AS arrival_time_only,
            CONCAT(
                FLOOR(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time) / 60), '小时',
                IF(MOD(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time), 60) > 0,
                   CONCAT(MOD(TIMESTAMPDIFF(MINUTE, t.departure_time, t.arrival_time), 60), '分'),
                   '')
            ) AS duration,
            (t.total_seats - COALESCE((SELECT COUNT(*) FROM seats s WHERE s.trip_id = t.trip_id AND s.seat_status IN (1, 2)), 0)) AS available_seats,
            t.total_seats,
            t.base_price
        FROM trips t
        LEFT JOIN stations ds ON t.departure_station_id = ds.station_id
        LEFT JOIN stations arr_station ON t.arrival_station_id = arr_station.station_id
        <where>
            <if test="tripNumber != null and tripNumber != ''">
                AND t.trip_number LIKE CONCAT('%', #{tripNumber}, '%')
            </if>
        </where>
        ORDER BY t.create_time DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{offset}, #{pageSize}
        </if>
    </select>
</mapper>

