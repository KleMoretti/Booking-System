# 订单超时自动取消与座位随机分配功能说明

## 功能概述

本次更新实现了以下前端功能：
1. **15分钟支付倒计时**：订单创建后15分钟内未支付自动取消
2. **订单列表倒计时显示**：待支付订单实时显示剩余支付时间
3. **订单超时自动取消**：倒计时结束后自动调用取消接口
4. **座位随机分配**：订票时自动分配座位号并在订单详情中显示

---

## 1. 订单状态扩展

### 新增超时状态

**文件**: `src/utils/constants.js`

添加了新的订单状态：
```javascript
export const ORDER_STATUS = {
  PENDING: 0,      // 待支付
  PAID: 1,         // 已支付
  CANCELLED: 2,    // 已取消
  REFUNDED: 3,     // 已退款
  COMPLETED: 4,    // 已完成
  TIMEOUT: 5,      // 已超时（新增）
}

// 订单支付超时时间（毫秒）
export const ORDER_TIMEOUT = 15 * 60 * 1000 // 15分钟
```

**文件**: `src/utils/format.js`

更新状态映射：
```javascript
export const orderStatusMap = {
  0: { text: '待支付', color: 'orange' },
  1: { text: '已支付', color: 'green' },
  2: { text: '已取消', color: 'red' },
  3: { text: '已退款', color: 'default' },
  4: { text: '已完成', color: 'blue' },
  5: { text: '已超时', color: 'volcano' }, // 新增
}
```

---

## 2. 支付页面倒计时与自动取消

### 功能说明

**文件**: `src/pages/Payment/index.jsx`

#### 核心改进：

1. **基于订单创建时间计算倒计时**
   - 不再使用固定的15分钟倒计时
   - 根据订单的 `createTime` 计算实际剩余时间
   - 如果打开支付页面时已经超时，立即取消订单

2. **倒计时结束自动取消订单**
   ```javascript
   const handleCountdownFinish = useCallback(async () => {
     if (cancelingRef.current) return
     cancelingRef.current = true
     
     try {
       await cancelOrder(orderId)
       message.warning('支付超时，订单已自动取消')
     } catch (error) {
       console.error('自动取消订单失败：', error)
       message.warning('支付超时')
     } finally {
       setTimeout(() => {
         navigate('/orders')
       }, 2000)
     }
   }, [orderId, navigate])
   ```

3. **截止时间计算逻辑**
   ```javascript
   // 根据订单创建时间计算倒计时截止时间
   if (response.data.createTime) {
     const createTime = dayjs(response.data.createTime).valueOf()
     const deadlineTime = createTime + ORDER_TIMEOUT
     const now = Date.now()
     
     // 如果已经超时，直接取消订单
     if (now >= deadlineTime) {
       handleCountdownFinish()
     } else {
       setDeadline(deadlineTime)
     }
   }
   ```

### 用户体验

- 页面顶部显示倒计时提示："请在 mm:ss 内完成支付"
- 倒计时用红色醒目显示
- 倒计时结束后：
  - 自动调用取消订单接口
  - 显示"支付超时，订单已自动取消"提示
  - 2秒后自动跳转回订单列表

---

## 3. 订单列表倒计时显示

### 功能说明

**文件**: `src/pages/OrderList/index.jsx`

#### 核心改进：

1. **待支付订单显示倒计时**
   - 在"订单状态"列中，待支付订单显示实时倒计时
   - 倒计时格式：`mm:ss`，红色显示
   - 倒计时结束自动取消订单并刷新列表

2. **倒计时计算函数**
   ```javascript
   // 计算订单的倒计时截止时间
   const getOrderDeadline = useCallback((order) => {
     if ((order.orderStatus ?? order.status) !== ORDER_STATUS.PENDING) {
       return null
     }
     const createTime = dayjs(order.createTime).valueOf()
     return createTime + ORDER_TIMEOUT
   }, [])
   ```

3. **订单状态列渲染**
   ```javascript
   render: (status, record) => {
     const statusInfo = getOrderStatus(status)
     const originalOrder = orderList.find(o => (o.orderId ?? o.id) === record.id)
     const deadline = originalOrder ? getOrderDeadline(originalOrder) : null
     
     if (status === ORDER_STATUS.PENDING && deadline) {
       const now = Date.now()
       if (now >= deadline) {
         // 已超时，触发自动取消
         setTimeout(() => handleCancelOrder(record.id, true), 100)
         return <Tag color="volcano">已超时</Tag>
       }
       return (
         <Space direction="vertical" size={0} style={{ textAlign: 'center' }}>
           <Tag color={statusInfo.color}>{statusInfo.text}</Tag>
           <Countdown
             value={deadline}
             format="mm:ss"
             valueStyle={{ fontSize: '12px', color: '#ff4d4f', lineHeight: '16px' }}
             onFinish={() => handleCancelOrder(record.id, true)}
           />
         </Space>
       )
     }
     return <Tag color={statusInfo.color}>{statusInfo.text}</Tag>
   }
   ```

### 用户体验

- 订单列表中待支付订单实时显示剩余时间
- 倒计时结束后：
  - 自动取消订单
  - 显示"订单已超时自动取消"提示
  - 自动刷新订单列表
  - 订单状态变为"已取消"

---

## 4. 座位随机分配功能

### Mock数据实现

**文件**: `src/mock/index.js`

#### 座位号生成逻辑

```javascript
// 生成随机座位号
const generateSeatNumber = () => {
  const carNumber = String(Math.floor(Math.random() * 8) + 1).padStart(2, '0') // 01-08车
  const rowNumber = String(Math.floor(Math.random() * 20) + 1).padStart(2, '0') // 01-20排
  const seatLetter = ['A', 'B', 'C', 'D', 'F'][Math.floor(Math.random() * 5)] // A-F座位
  return `${carNumber}车${rowNumber}${seatLetter}`
}
```

#### 订单创建增强

创建订单时：
1. 为每个乘客生成唯一的随机座位号
2. 创建完整的车票信息（包含座位号、价格、状态等）
3. 返回完整的订单详情结构

```javascript
// 生成车票列表
const tickets = data.passengers.map((passenger, index) => ({
  ticketId: Math.floor(Math.random() * 100000) + index,
  passengerName: passenger.name,
  passengerIdCard: passenger.idCard,
  seatNumber: generateSeatNumber(), // 随机座位号
  price: basePrice,
  ticketStatus: 0, // 未使用
  ticketStatusText: '未使用',
}))
```

### 座位号格式

- **格式**: `XX车XXY` 
  - 例如：`03车06A`、`05车12B`
- **车厢**: 01-08车
- **排号**: 01-20排
- **座位**: A、B、C、D、F

### 显示位置

座位号在以下位置显示：
1. **订单详情Modal** - 车票信息表格中的"座位号"列
2. **支付页面** - （如果需要可以添加）
3. **电子车票** - 乘车信息中显示

---

## 5. Mock数据更新

### 订单数据结构统一

**文件**: `src/mock/data.js`

将所有mock订单更新为统一的数据结构：

```javascript
{
  orderId: 1,           // 订单ID
  id: 1,                // 兼容字段
  orderNumber: 'ORD...', // 订单号
  tripNumber: 'G101',   // 车次号
  departureStation: '北京南',
  arrivalStation: '上海虹桥',
  departureTime: '2025-12-16 08:00:00',
  arrivalTime: '2025-12-16 13:30:00',
  totalAmount: 553,     // 订单总额
  paidAmount: 553,      // 已支付金额
  orderStatus: 1,       // 订单状态（数字）
  status: 1,            // 兼容字段
  orderStatusText: '已支付',
  statusText: '已支付',
  createTime: '2025-12-15 10:30:00',
  payTime: '2025-12-15 10:35:00',
  tickets: [            // 车票列表
    {
      ticketId: 1001,
      passengerName: '张三',
      passengerIdCard: '110101199001011234',
      seatNumber: '03车06A', // 座位号
      price: 553,
      ticketStatus: 0,
      ticketStatusText: '未使用',
    }
  ],
}
```

### 测试用订单

添加了一个5分钟前创建的待支付订单（ID: 3），用于测试倒计时功能：
```javascript
createTime: new Date(Date.now() - 5 * 60 * 1000).toISOString(), 
// 5分钟前创建，还有10分钟支付时间
```

---

## 6. 订单状态更新

### 取消订单

**文件**: `src/mock/index.js`

```javascript
mock.onPost(/\/order\/\d+\/cancel/).reply((config) => {
  const orderId = parseInt(config.url.split('/')[2])
  
  // 更新订单状态
  const order = mockOrders.find(o => (o.orderId ?? o.id) === orderId)
  if (order) {
    order.orderStatus = 2 // 已取消
    order.status = 2
    order.orderStatusText = '已取消'
    order.statusText = '已取消'
  }
  
  return [200, { code: 200, message: '订单已取消' }]
})
```

### 支付订单

```javascript
mock.onPost(/\/order\/\d+\/pay/).reply((config) => {
  const orderId = parseInt(config.url.split('/')[2])
  
  // 更新订单状态
  const order = mockOrders.find(o => (o.orderId ?? o.id) === orderId)
  if (order) {
    order.orderStatus = 1 // 已支付
    order.status = 1
    order.orderStatusText = '已支付'
    order.statusText = '已支付'
    order.paidAmount = order.totalAmount
    order.payTime = new Date().toISOString()
  }
  
  return [200, { code: 200, message: '支付成功' }]
})
```

---

## 测试指南

### 1. 测试订单超时自动取消

**步骤**：
1. 登录系统
2. 查询车次并创建订单
3. 进入支付页面，观察倒计时
4. 等待15分钟或修改 `ORDER_TIMEOUT` 为更短时间（如 1分钟）
5. 倒计时结束后，订单自动取消并跳转回订单列表

**预期结果**：
- 支付页面显示倒计时
- 倒计时结束后显示"支付超时，订单已自动取消"
- 自动跳转到订单列表
- 订单状态变为"已取消"

### 2. 测试订单列表倒计时

**步骤**：
1. 登录系统
2. 进入"我的订单"页面
3. 查看待支付订单（mock数据中的订单ID: 3）
4. 观察订单状态列中的倒计时

**预期结果**：
- 待支付订单显示"待支付"标签和倒计时
- 倒计时格式为 `mm:ss`，红色显示
- 倒计时结束后自动取消订单
- 订单列表自动刷新，订单状态变为"已取消"

### 3. 测试座位随机分配

**步骤**：
1. 登录系统
2. 查询车次
3. 选择一个车次点击"订票"
4. 填写乘客信息并提交订单
5. 查看订单详情

**预期结果**：
- 订单创建成功
- 订单详情中显示车票信息
- 每张车票都有随机分配的座位号
- 座位号格式：`XX车XXY`（如 `03车06A`）

### 4. 测试多人订票

**步骤**：
1. 修改前端代码，允许添加多个乘客
2. 为同一车次订2-3张票
3. 查看订单详情

**预期结果**：
- 每个乘客都有独立的车票
- 每张车票都有不同的随机座位号
- 订单总额 = 票价 × 乘客数量

---

## 技术要点

### 1. 时间处理

- 使用 `dayjs` 库处理时间计算
- 倒计时基于订单创建时间（`createTime`）而非当前时间
- 确保时间计算的准确性

### 2. 状态同步

- 订单取消后立即更新 mock 数据
- 订单列表自动刷新以反映最新状态
- 支付成功后更新订单的 `payTime` 和 `paidAmount`

### 3. 防重复操作

- 使用 `useRef` 防止倒计时结束时重复调用取消接口
- 支付页面的 `cancelingRef.current` 标志位

### 4. 用户体验优化

- 倒计时用红色醒目显示
- 自动取消后给出明确提示
- 操作完成后自动跳转或刷新

---

## 注意事项

### 前端实现的局限性

本次实现是**纯前端**的模拟实现，在实际生产环境中需要注意：

1. **真实环境需要后端支持**：
   - 后端应该有定时任务检查超时订单
   - 座位分配应该在后端进行，确保唯一性
   - 订单状态更新应该由后端触发

2. **座位分配**：
   - 当前是随机生成座位号，不检查重复
   - 真实环境需要检查座位是否已被占用
   - 需要考虑座位锁定机制

3. **倒计时同步**：
   - 前端倒计时可能因为浏览器休眠等原因不准确
   - 应该定期向后端查询订单状态
   - 后端应该是订单状态的最终权威

4. **Mock数据持久化**：
   - 当前Mock数据存在内存中，刷新页面会重置
   - 可以考虑使用 `localStorage` 持久化

### 后续优化建议

1. **添加订单状态轮询**：
   - 在订单列表页面定期查询订单状态
   - 确保状态与后端同步

2. **座位可视化**：
   - 实现座位图，让用户可以选座
   - 显示座位占用情况

3. **通知提醒**：
   - 订单即将超时前5分钟提醒用户
   - 支持浏览器通知或站内消息

4. **订单恢复**：
   - 允许用户重新支付已取消的订单
   - 重新分配座位并创建新订单

---

## 文件修改清单

### 修改的文件

1. `src/utils/constants.js` - 添加超时状态和超时时间常量
2. `src/utils/format.js` - 更新订单状态映射
3. `src/pages/Payment/index.jsx` - 实现倒计时和自动取消
4. `src/pages/OrderList/index.jsx` - 显示倒计时和自动取消
5. `src/mock/index.js` - 增强创建订单、更新取消和支付逻辑
6. `src/mock/data.js` - 统一订单数据结构

### 新增的文件

- 无（所有改动都是修改现有文件）

---

## 总结

本次更新成功实现了：

✅ **订单15分钟支付超时机制**
- 支付页面倒计时显示
- 倒计时结束自动取消订单
- 基于订单创建时间计算准确的剩余时间

✅ **订单列表实时倒计时**
- 待支付订单显示剩余支付时间
- 超时自动取消并刷新列表
- 直观的红色倒计时提醒

✅ **座位随机分配**
- 订票时自动为每个乘客分配座位
- 座位号格式规范（XX车XXY）
- 订单详情中清晰展示

✅ **订单状态管理**
- 新增"已超时"状态
- 取消和支付操作正确更新订单状态
- 支持订单状态实时同步

所有功能均已在前端完成，使用Mock数据即可测试全部流程。
