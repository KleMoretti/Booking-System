# 订单状态定义说明

## 订单状态流转图

```
创建订单 → 待支付(0) → 已支付(1) → 已完成(4)
              ↓              ↓
           已取消(2)     已退款(3)
```

## 状态详细说明

### 1. 待支付 (PENDING = 0)
**定义：** 订单已创建，等待用户支付

**触发时机：**
- 用户完成选座、填写乘客信息，点击"提交订单"后

**允许操作：**
- 去支付
- 取消订单

**时间限制：**
- 通常有支付倒计时（如15分钟）
- 超时未支付自动取消

**前端显示：**
- 颜色：橙色 (orange)
- 文案："待支付"

---

### 2. 已支付 (PAID = 1)
**定义：** 订单已支付成功，等待乘车

**触发时机：**
- 用户完成支付（余额/支付宝/微信支付）

**状态说明：**
- 订单已完成支付
- 车票已生成
- **车次尚未发车**（发车前）

**允许操作：**
- 查看订单详情
- 查看电子车票
- 改签
- 退票

**时间范围：**
- 从支付成功到发车前

**前端显示：**
- 颜色：蓝色 (blue)
- 文案："已支付"

---

### 3. 已完成 (COMPLETED = 4)
**定义：** 车次已发车且乘车完毕

**触发时机：**
- **系统自动判断：** 当前时间 > 车次发车时间

**状态说明：**
- 车次已经发车
- 乘客已经乘车或应该已经乘车
- 订单生命周期结束
- 不可再进行退改签操作

**允许操作：**
- 查看订单详情
- 查看电子车票（历史记录）
- 申请发票

**不允许操作：**
- 退票（已发车）
- 改签（已发车）

**前端显示：**
- 颜色：绿色 (green)
- 文案："已完成"

---

### 4. 已取消 (CANCELLED = 2)
**定义：** 订单已取消

**触发时机：**
- 用户主动取消待支付订单
- 超时未支付自动取消

**前端显示：**
- 颜色：灰色/默认 (default)
- 文案："已取消"

---

### 5. 已退款 (REFUNDED = 3)
**定义：** 订单已退票退款

**触发时机：**
- 用户申请退票且处理成功
- 管理员处理退票请求

**状态说明：**
- 原订单已作废
- 退款已处理

**前端显示：**
- 颜色：红色 (red)
- 文案："已退款"

---

## 关键判断逻辑

### 已支付 vs 已完成的区别

```javascript
// 判断订单是否应该是"已完成"状态
const isDeparted = dayjs().isAfter(dayjs(order.departureTime))

if (order.orderStatus === ORDER_STATUS.PAID && isDeparted) {
  // 虽然数据库状态是"已支付"，但实际应该显示为"已完成"
  // 或者后端定时任务将状态更新为COMPLETED
}
```

### 后端建议

建议使用定时任务每小时检查已支付订单：

```java
@Scheduled(cron = "0 0 * * * ?") // 每小时执行
public void updateCompletedOrders() {
    // 查询所有已支付订单
    List<Order> paidOrders = orderMapper.selectByStatus(OrderStatus.PAID);
    
    for (Order order : paidOrders) {
        // 如果发车时间已过
        if (order.getDepartureTime().before(new Date())) {
            order.setOrderStatus(OrderStatus.COMPLETED);
            orderMapper.updateById(order);
        }
    }
}
```

---

## 前端展示逻辑

### 订单列表

根据发车时间动态显示状态：

```javascript
// 如果订单状态是已支付，但已经发车了
if (order.orderStatus === ORDER_STATUS.PAID) {
  const isDeparted = dayjs().isAfter(dayjs(order.departureTime))
  
  if (isDeparted) {
    // 显示为"已完成"
    displayStatus = { text: '已完成', color: 'green' }
  } else {
    // 显示为"已支付"
    displayStatus = { text: '已支付', color: 'blue' }
  }
}
```

### 退改签页面

只显示可退改签的订单（已支付且未发车）：

```javascript
const eligibleOrders = orderList.filter(order => {
  const isDeparted = dayjs().isAfter(dayjs(order.departureTime))
  return order.orderStatus === ORDER_STATUS.PAID && !isDeparted
})
```

---

## 用户场景示例

### 场景1：正常购票乘车

1. **12:00** - 用户购买14:00的车票 → **待支付**
2. **12:05** - 用户完成支付 → **已支付**
3. **13:00** - 用户可以查看电子车票，可以退改签 → **已支付**
4. **14:01** - 车次发车，系统自动更新 → **已完成**
5. **14:30** - 用户查看订单，显示已完成，不能退改签 → **已完成**

### 场景2：支付后退票

1. **12:00** - 用户购买14:00的车票 → **待支付**
2. **12:05** - 用户完成支付 → **已支付**
3. **12:30** - 用户申请退票 → **已退款**

### 场景3：超时未支付

1. **12:00** - 用户购买14:00的车票 → **待支付**
2. **12:15** - 超过15分钟未支付 → **已取消**

---

## 总结

**核心区别：**
- **已支付** = 钱已付，车未发，可以退改签
- **已完成** = 车已发，行程结束，不能退改签

**判断依据：**
- 当前时间 vs 发车时间
- 当前时间 > 发车时间 → 已完成
- 当前时间 ≤ 发车时间 → 已支付

**业务意义：**
- 已支付：订单处理中，等待服务
- 已完成：订单已履约，服务完成
