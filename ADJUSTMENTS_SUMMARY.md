# 系统调整总结

## 调整时间
2025-12-14

## 调整内容

### ✅ 1. 车次管理与票价管理职责分离

**调整前：**
- 车次管理页面包含座位和票价编辑
- 票价管理只能修改票价

**调整后：**
- **车次管理**：专注车次基本信息（车次号、类型、站点、时间、日期）
- **票价管理**：管理座位信息和票价（总座位数、可售座位数、票价）

**修改文件：**
- `TripFormModal.jsx` - 移除座位信息字段
- `PriceManagement.jsx` - 新增座位编辑功能，添加表单验证

**优势：**
- 职责更清晰
- 票价和库存集中管理
- 避免编辑车次时误改座位信息

---

### ✅ 2. 搜索历史用户独立存储

**调整前：**
- 所有用户共享同一个搜索历史缓存
- localStorage key: `booking_search_history`

**调整后：**
- 每个用户拥有独立的搜索历史
- localStorage key: `booking_search_history_{userId}`
- 未登录用户使用: `booking_search_history_guest`

**修改文件：**
- `useSearchHistory.js` - 使用Redux获取用户信息，动态生成存储key

**优势：**
- 隐私保护
- 个性化搜索记录
- 多用户使用同一设备时互不干扰

---

### ✅ 3. 管理后台功能调整

**调整前：**
- 菜单项：数据总览、改签退票管理、车次管理、票价管理

**调整后：**
- 菜单项：数据总览、**站点管理**、车次管理、票价管理

**新增功能：站点管理**
- 查看所有站点列表
- 添加新站点（名称、代码、城市、地址）
- 编辑站点信息
- 删除站点（带确认提示）
- 分页显示

**修改文件：**
- `Admin/index.jsx` - 替换菜单项和路由
- `Admin/StationManagement.jsx` - 新建站点管理页面

**优势：**
- 管理员可直接管理站点数据
- 减少数据库手动操作
- 站点信息规范化

---

### ✅ 4. 退改签发车时间检查

**调整前：**
- 可以对已发车的订单进行退票/改签操作
- 错误提示："订单不存在或已被处理"

**调整后：**
- 打开退票/改签弹窗前检查发车时间
- 已发车订单禁止退票改签
- 友好提示："该车次已发车，无法退票/改签"

**修改文件：**
- `RefundChange/index.jsx`
  - `handleOpenRefund` - 添加发车时间检查
  - `handleOpenChange` - 添加发车时间检查

**检查逻辑：**
```javascript
const departureTime = dayjs(record.departureTime)
const now = dayjs()

if (now.isAfter(departureTime)) {
  message.warning('该车次已发车，无法退票/改签')
  return
}
```

**优势：**
- 业务逻辑更合理
- 用户体验更好
- 避免无效操作

---

### ✅ 5. 已发车车票视觉标记

**调整前：**
- 所有订单显示样式一致
- 无法快速识别已发车订单

**调整后：**
- 已发车订单以灰色显示
- 出发时间后添加"已发车"标签
- 改签/退票按钮禁用

**视觉变化：**

| 字段 | 未发车 | 已发车 |
|------|--------|--------|
| 订单号 | 黑色 | 灰色 (#999) |
| 车次 | 蓝色Tag | 灰色Tag (default) |
| 出发时间 | 黑色 | 灰色 + "已发车"标签 |
| 订单金额 | 黑色 | 灰色 |
| 改签按钮 | 启用 | 禁用 (disabled) |
| 退票按钮 | 启用 | 禁用 (disabled) |

**修改文件：**
- `RefundChange/index.jsx` - 所有列的render函数添加发车状态判断

**判断逻辑：**
```javascript
const isDeparted = dayjs().isAfter(dayjs(record.departureTime))
```

**优势：**
- 视觉上快速区分订单状态
- 防止用户误操作
- 提升用户体验

---

## 文件修改清单

### 新增文件
```
Admin/StationManagement.jsx          # 站点管理页面
```

### 修改文件
```
Admin/index.jsx                      # 菜单调整
Admin/TripFormModal.jsx              # 移除座位字段
Admin/PriceManagement.jsx            # 新增座位编辑
hooks/useSearchHistory.js            # 用户独立存储
pages/RefundChange/index.jsx         # 发车检查和视觉标记
```

---

## 测试建议

### 1. 车次和票价管理
- [ ] 创建车次时不需要填写座位信息
- [ ] 编辑车次时不显示座位字段
- [ ] 在票价管理中可以编辑座位数
- [ ] 可售座位数不能超过总座位数（表单验证）

### 2. 搜索历史
- [ ] 登录用户A，搜索车次，查看历史
- [ ] 登出，登录用户B，确认看不到用户A的历史
- [ ] 未登录状态，搜索记录保存到guest
- [ ] 登录后，guest历史不影响用户历史

### 3. 站点管理
- [ ] 查看站点列表
- [ ] 添加新站点（必填字段验证）
- [ ] 编辑站点信息
- [ ] 删除站点（确认弹窗）

### 4. 退改签时间检查
- [ ] 选择未发车订单，可以打开退票弹窗
- [ ] 选择已发车订单，显示提示，不打开弹窗
- [ ] 改签同上

### 5. 已发车视觉标记
- [ ] 创建一个发车时间已过的测试订单
- [ ] 确认订单号、车次、时间、金额显示为灰色
- [ ] 确认出发时间后有"已发车"标签
- [ ] 确认改签和退票按钮被禁用

---

## 兼容性说明

### 后端需求

**站点管理需要的API：**
```
GET    /api/stations          # 获取站点列表（已存在）
POST   /api/stations          # 创建站点（需新增）
PUT    /api/stations/{id}     # 更新站点（需新增）
DELETE /api/stations/{id}     # 删除站点（需新增）
```

**票价管理API调整：**
```
PUT /api/admin/trips/{id}/price
```
请求体需要支持：
```json
{
  "price": 100.00,
  "availableSeats": 500,
  "totalSeats": 600
}
```

### 数据库
无需修改数据库结构，所有字段已存在。

---

## 注意事项

1. **搜索历史迁移**
   - 现有用户的搜索历史会丢失（旧key无用户ID）
   - 建议在更新说明中告知用户

2. **站点管理权限**
   - 仅管理员可访问
   - 删除站点前需检查是否有关联车次

3. **时间判断**
   - 使用dayjs进行时间比较
   - 确保前后端时区一致

4. **缓存问题**
   - 用户切换后需要清除旧用户的数据
   - 退出登录时建议清除guest历史

---

## 后续优化建议

1. **站点管理**
   - 添加批量导入功能
   - 站点关联车次数量显示
   - 删除前检查关联数据

2. **搜索历史**
   - 添加历史同步功能（多设备）
   - 支持历史搜索排序（按时间/频率）

3. **退改签**
   - 添加发车前N小时提醒
   - 改签价差预览更详细
   - 支持部分退票

4. **视觉优化**
   - 已发车订单支持筛选
   - 添加"即将发车"提示（如2小时内）
   - 历史订单归档功能

---

## 相关文档

- [新功能使用指南](./NEW_FEATURES_GUIDE.md)
- [系统概览](./SYSTEM_OVERVIEW_README.md)
- [实现总结](./IMPLEMENTATION_SUMMARY.md)
