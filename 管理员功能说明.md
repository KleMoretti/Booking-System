# 管理员功能说明文档

## 功能概述

本次更新实现了以下管理员核心功能（前端 + API接口 + Mock数据）：

1. **用户管理**：搜索用户、重置密码、冻结/解冻账号
2. **批量车次管理**：批量导入、批量上线/下线车次
3. **财务报表**：日/周/月销售额、退票金额、净收入汇总

所有功能均已在前端完成，并配置了完整的Mock API实现。后端只需按照定义的接口规范实现即可对接。

---

## 一、用户管理

### 页面位置
管理后台 → 用户管理

### 核心功能

#### 1. 搜索用户
- **搜索字段**：用户名、手机号、身份证号
- **搜索方式**：模糊搜索，支持部分匹配
- **显示信息**：
  - 用户ID
  - 用户名
  - 真实姓名
  - 手机号
  - 身份证号（脱敏显示）
  - 账号状态（正常/已冻结）
  - 账户余额
  - 注册时间

#### 2. 查看用户详情
- 点击"详情"按钮查看完整用户信息
- 包含：
  - 基本信息
  - 最近登录时间
  - 历史订单数量
  - 账户余额

#### 3. 重置密码
- **操作流程**：
  1. 点击"重置密码"按钮
  2. 输入新密码（6-20位）
  3. 填写重置原因（将记录到操作日志）
  4. 确认提交

- **安全要求**：
  - 必须填写重置原因
  - 密码长度6-20位
  - 操作会被记录到审计日志

#### 4. 冻结/解冻账号
- **冻结功能**：
  - 冻结后用户无法登录系统
  - 需要二次确认
  - 自动记录操作原因

- **解冻功能**：
  - 解冻后用户恢复正常使用
  - 需要二次确认

### API接口

```javascript
// 搜索用户
GET /admin/users/search
params: { keyword, page, pageSize }

// 获取用户详情
GET /admin/users/:userId

// 重置密码
POST /admin/users/:userId/reset-password
data: { newPassword, reason }

// 冻结用户
POST /admin/users/:userId/freeze
data: { reason }

// 解冻用户
POST /admin/users/:userId/unfreeze
```

### Mock数据

Mock用户列表包含4个测试用户：
- `testuser` - 张三（正常用户）
- `user02` - 李四（正常用户）
- `frozen_user` - 王五（已冻结）
- `user04` - 赵六（高价值用户）

---

## 二、批量车次管理

### 页面位置
管理后台 → 批量车次管理

### 核心功能

#### 1. 批量导入车次
- **支持格式**：Excel (.xlsx, .xls) / CSV
- **文件大小**：不超过5MB
- **操作流程**：
  1. 下载导入模板
  2. 填写车次信息（车次号、出发站、到达站、时间、票价、座位数等）
  3. 上传文件
  4. 系统自动检查并导入

- **导入反馈**：
  - 成功导入数量
  - 失败数量（如有）
  - 失败原因说明

#### 2. 下载导入模板
- 点击"下载导入模板"按钮
- 自动下载Excel模板文件
- 模板包含必填字段说明

#### 3. 批量上线/下线车次
- **批量选择**：通过表格复选框选择多个车次
- **批量上线**：
  - 选中已下线的车次
  - 点击"批量上线"
  - 确认后生效

- **批量下线**：
  - 选中运营中的车次
  - 点击"批量下线"
  - 确认后用户将无法订票

#### 4. 加开车次
- **使用场景**：节假日临时加开车次
- **操作流程**：
  1. 选择加开日期范围
  2. 选择参考车次（复制线路信息）
  3. 系统自动在指定日期生成车次

- **注意**：目前加开功能引导使用批量导入实现

#### 5. 车次列表管理
- **显示信息**：
  - 车次号
  - 出发站/到达站
  - 出发时间/到达时间
  - 票价
  - 余票数量
  - 状态（运营中/已下线）
  - 创建时间

- **状态筛选**：
  - 可按状态筛选车次
  - 支持分页展示

### API接口

```javascript
// 获取管理员车次列表
GET /admin/trips
params: { page, pageSize }

// 批量导入车次
POST /admin/trips/batch-import
data: FormData (file)

// 批量下线车次
POST /admin/trips/batch-offline
data: { tripIds: [1, 2, 3] }

// 批量上线车次
POST /admin/trips/batch-online
data: { tripIds: [1, 2, 3] }

// 下载导入模板
GET /admin/trips/template
responseType: 'blob'
```

### 导入模板字段

| 字段名 | 说明 | 必填 | 示例 |
|--------|------|------|------|
| 车次号 | 如G101, D201 | 是 | G101 |
| 出发站 | 站点名称 | 是 | 北京南 |
| 到达站 | 站点名称 | 是 | 上海虹桥 |
| 出发日期 | YYYY-MM-DD | 是 | 2025-12-20 |
| 出发时间 | HH:mm | 是 | 08:00 |
| 到达时间 | HH:mm | 是 | 13:30 |
| 票价 | 元 | 是 | 553 |
| 座位数 | 总座位数 | 是 | 300 |

---

## 三、财务报表

### 页面位置
管理后台 → 财务报表

### 核心功能

#### 1. 汇总统计卡片
页面顶部显示4个关键指标：
- **总销售额**：选定时间范围内的总销售额（绿色）
- **总退票金额**：选定时间范围内的退票金额（红色）
- **净收入**：销售额 - 退票金额（蓝色，加粗）
- **订单/退票数**：订单总数 / 退票总数

#### 2. 报表类型选择
- **按日汇总**：每天一条记录
- **按周汇总**：每周一条记录
- **按月汇总**：每月一条记录

#### 3. 日期范围选择
- **自定义范围**：使用日期选择器
- **快速选择**：
  - 近7天
  - 近30天
  - 近90天

#### 4. 数据详情表格

| 列名 | 说明 | 显示格式 |
|------|------|----------|
| 日期 | 日/周/月 | 2025-12-14 / 第50周 / 2025年12月 |
| 销售额 | 总销售额 | ¥12,345.67（绿色） |
| 退票金额 | 退票总额 | ¥1,234.56（红色） |
| 净收入 | 销售额-退票 | ¥11,111.11（加粗） |
| 订单数 | 订单总数 | 123 |
| 退票数 | 退票总数 | 12 |
| 退票率 | 退票数/订单数 | 9.76% |
| 环比 | 与上期对比 | ↑5.32% / ↓3.21% |

#### 5. 表格合计行
- 表格底部显示所选时间范围的总计
- 包含：总销售额、总退票、净收入、订单数、退票数、平均退票率

#### 6. 导出功能
- 点击"导出Excel"按钮
- 下载当前查询结果的Excel文件
- 文件名格式：`财务报表_起始日期-结束日期.xlsx`

### API接口

```javascript
// 获取财务报表
GET /admin/financial/report
params: { 
  startDate: '2025-12-01', 
  endDate: '2025-12-14', 
  reportType: 'daily' // daily/weekly/monthly
}

// 获取销售统计
GET /admin/financial/sales
params: { startDate, endDate }

// 导出财务报表
GET /admin/financial/export
params: { startDate, endDate, reportType }
responseType: 'blob'
```

### 数据结构

#### 报表Summary响应：
```javascript
{
  summary: {
    totalSales: 156789.50,      // 总销售额
    totalRefund: 12345.67,      // 总退票金额
    netIncome: 144443.83,       // 净收入
    orderCount: 1234,           // 订单数
    refundCount: 123,           // 退票数
  },
  details: [
    {
      date: '2025-12-14',
      sales: 12345.67,
      refund: 1234.56,
      netIncome: 11111.11,
      orderCount: 123,
      refundCount: 12,
      growth: 5.32,             // 环比增长率（%）
    },
    // ... more records
  ]
}
```

---

## 四、访问权限

### 管理员登录
- 使用管理员账号登录系统
- 用户名：`admin`
- 系统自动识别管理员身份

### 权限控制
- 普通用户无法访问管理后台
- 管理员可访问所有管理功能
- 前端使用 `<AdminRoute>` 组件保护路由

---

## 五、Mock数据说明

### 用户数据
- 提供4个测试用户
- 包含正常用户和已冻结用户
- 支持搜索、冻结、解冻操作

### 车次数据
- 基于现有mockTrips数据
- 自动转换为管理员视图格式
- 支持批量上线/下线状态更新

### 财务数据
- 动态生成报表数据
- 按日期范围和报表类型生成
- 包含销售额、退票、净收入等指标
- 随机生成环比增长率

---

## 六、文件清单

### 新增文件

#### API接口定义
- `src/api/admin.js` - 新增用户管理、批量车次管理、财务报表接口

#### 页面组件
- `src/pages/Admin/UserManagement/index.jsx` - 用户管理页面
- `src/pages/Admin/UserManagement/style.css` - 用户管理样式
- `src/pages/Admin/BatchTripManagement/index.jsx` - 批量车次管理页面
- `src/pages/Admin/BatchTripManagement/style.css` - 批量车次管理样式
- `src/pages/Admin/FinancialReport/index.jsx` - 财务报表页面
- `src/pages/Admin/FinancialReport/style.css` - 财务报表样式

### 修改文件

#### Mock数据
- `src/mock/index.js` - 新增用户管理、批量车次管理、财务报表Mock API

#### 路由配置
- `src/pages/Admin/index.jsx` - 添加新菜单项和路由

---

## 七、使用指南

### 1. 访问管理后台
1. 使用管理员账号登录（username: `admin`）
2. 点击导航栏"管理后台"或访问 `/admin`
3. 系统自动显示管理后台界面

### 2. 用户管理
1. 点击左侧菜单"用户管理"
2. 在搜索框输入关键词（用户名/手机号/身份证号）
3. 点击"搜索"查看结果
4. 对用户进行：查看详情、重置密码、冻结/解冻操作

### 3. 批量车次管理
1. 点击左侧菜单"批量车次管理"
2. 批量导入：
   - 点击"批量导入车次"
   - 先下载模板
   - 填写车次信息后上传
3. 批量操作：
   - 勾选需要操作的车次
   - 点击"批量上线"或"批量下线"

### 4. 财务报表
1. 点击左侧菜单"财务报表"
2. 选择报表类型（日/周/月）
3. 选择日期范围或使用快速选择
4. 点击"查询"查看报表
5. 点击"导出Excel"下载报表

---

## 八、测试用例

### 用户管理测试

#### 测试搜索功能
1. 搜索"张三" → 应显示1条结果
2. 搜索"138" → 应显示包含该手机号的用户
3. 搜索"110101" → 应显示该身份证开头的用户
4. 搜索不存在的关键词 → 显示空结果

#### 测试冻结/解冻
1. 选择正常用户，点击"冻结" → 用户状态变为"已冻结"
2. 选择已冻结用户，点击"解冻" → 用户状态变为"正常"

#### 测试重置密码
1. 点击"重置密码"
2. 输入新密码和原因
3. 提交成功 → 显示"密码重置成功"

### 批量车次管理测试

#### 测试车次列表
1. 进入页面 → 显示车次列表
2. 查看分页 → 分页正常工作

#### 测试批量上线/下线
1. 勾选多个车次
2. 点击"批量下线" → 状态变为"已下线"
3. 勾选已下线车次
4. 点击"批量上线" → 状态变为"运营中"

#### 测试批量导入
1. 点击"下载导入模板" → 成功下载
2. 点击"批量导入车次" → 打开上传对话框
3. 上传文件 → 显示导入成功及数量

### 财务报表测试

#### 测试报表查询
1. 选择"按日汇总" + 近7天 → 显示7条记录
2. 选择"按周汇总" + 近30天 → 显示约4-5条记录
3. 选择"按月汇总" + 近90天 → 显示3条记录

#### 测试汇总卡片
1. 查询后 → 顶部4个卡片显示汇总数据
2. 数据应该与表格合计行一致

#### 测试导出
1. 点击"导出Excel" → 成功下载文件
2. 文件名包含日期范围

---

## 九、后端对接说明

### 数据库设计建议

#### 用户表扩展
需要添加以下字段：
- `status` - 账号状态（0=正常，1=已冻结）
- `last_login_time` - 最近登录时间
- `order_count` - 订单数量（可计算得出）

#### 操作日志表
建议新建表记录管理员操作：
```sql
CREATE TABLE admin_operation_log (
  id BIGINT PRIMARY KEY,
  admin_id BIGINT,           -- 操作管理员ID
  operation_type VARCHAR(50), -- 操作类型（reset_password/freeze_user等）
  target_id BIGINT,          -- 操作目标ID
  reason TEXT,               -- 操作原因
  create_time DATETIME       -- 操作时间
);
```

#### 车次表扩展
需要添加以下字段：
- `status` - 车次状态（0=已下线，1=运营中）
- `create_time` - 创建时间

### API实现要点

#### 用户管理
1. 搜索接口需支持模糊搜索（LIKE查询）
2. 重置密码需记录操作日志
3. 冻结/解冻需更新用户状态并记录日志

#### 批量车次管理
1. 批量导入需解析Excel文件（使用Apache POI或类似库）
2. 需要数据校验（车次号唯一、站点存在、时间合法等）
3. 批量上线/下线需事务处理

#### 财务报表
1. 需要从订单表聚合统计
2. 按日期分组查询（GROUP BY DATE）
3. 计算环比需要关联上一期数据
4. 导出Excel可使用Apache POI

### 错误处理
- 用户不存在：返回404
- 权限不足：返回403
- 参数错误：返回400 + 详细错误信息
- 服务器错误：返回500

---

## 十、注意事项

### 安全性
1. 所有管理员操作需要记录操作日志
2. 敏感操作（重置密码、冻结账号）需要填写原因
3. 身份证号在前端显示时需脱敏（使用formatIdCard函数）

### 性能
1. 用户搜索建议添加索引（username, phone, idCard）
2. 财务报表查询建议添加日期索引
3. 大量数据导入建议使用异步任务队列

### 用户体验
1. 所有危险操作需要二次确认
2. 操作成功后显示明确的提示信息
3. 列表支持分页，避免一次加载过多数据
4. 长时间操作显示加载状态

---

## 总结

本次更新完成了管理员系统的核心功能，包括：

✅ **用户管理** - 搜索、查看、重置密码、冻结/解冻
✅ **批量车次管理** - 导入、上线/下线、模板下载
✅ **财务报表** - 日/周/月汇总、导出Excel

所有功能均提供：
- ✅ 完整的前端页面和交互
- ✅ API接口定义
- ✅ Mock数据实现
- ✅ 用户体验优化

后端开发只需按照API接口规范实现业务逻辑即可无缝对接！
