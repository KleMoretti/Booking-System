# 新功能使用指南

本文档介绍最新添加的功能：常用联系人管理、发票管理、电子车票展示等。

---

## 一、数据库扩展

### 1.1 执行扩展脚本

在使用新功能前，需要先执行数据库扩展脚本：

```bash
mysql -u root -p booking_system < booking-system-backend/src/main/resources/db/add_new_features.sql
```

### 1.2 新增数据表

脚本将创建以下新表：

- **passengers** - 常用联系人表
- **invoices** - 发票记录表
- **invoice_titles** - 发票抬头表

同时增强以下表：
- **tickets** - 添加取票号、二维码、检票口等字段
- **orders** - 添加行程单、联系方式等字段

---

## 二、常用联系人管理

### 2.1 功能入口

**个人中心** → **常用联系人** 标签页

### 2.2 主要功能

1. **添加联系人**
   - 点击"添加联系人"按钮
   - 填写乘客信息：
     - 姓名（必填）
     - 证件类型（身份证/护照/其他）
     - 证件号码（必填）
     - 联系电话（可选）
     - 旅客类型（成人/儿童/学生）
     - 是否设为默认

2. **编辑联系人**
   - 点击列表中的"编辑"按钮
   - 修改信息后保存

3. **删除联系人**
   - 点击列表中的"删除"按钮
   - 确认后删除

4. **使用联系人**
   - 购票时可选择常用联系人
   - 默认联系人会自动填充

### 2.3 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| passenger_name | VARCHAR(50) | 乘客姓名 |
| id_card_type | TINYINT | 0=身份证，1=护照，2=其他 |
| id_card_no | VARCHAR(32) | 证件号码 |
| phone | VARCHAR(20) | 联系电话 |
| passenger_type | TINYINT | 0=成人，1=儿童，2=学生 |
| is_default | TINYINT | 0=否，1=是 |

---

## 三、发票管理

### 3.1 功能入口

**个人中心** → **发票管理** 标签页

包含两个子标签：
- **发票记录** - 查看已申请的发票
- **发票抬头** - 管理常用发票抬头

### 3.2 申请发票

1. 在"发票记录"标签页点击"申请发票"
2. 填写申请信息：
   - 订单号（必填）
   - 发票类型（电子普通发票/增值税专用发票）
   - 发票抬头（必填）
   - 纳税人识别号（企业发票必填）
   - 接收邮箱（必填）
   - 备注（可选）

3. 提交后等待开具
4. 发票开具后可下载

### 3.3 发票抬头管理

1. **添加抬头**
   - 点击"添加抬头"按钮
   - 选择抬头类型（个人/企业）
   - 填写抬头信息
   - 企业抬头可填写：
     - 纳税人识别号
     - 开户银行
     - 银行账号
     - 企业地址
     - 企业电话

2. **使用抬头**
   - 申请发票时可选择已保存的抬头
   - 设为默认的抬头会自动填充

### 3.4 发票状态

| 状态 | 说明 | 颜色 |
|------|------|------|
| 待开具 | 申请已提交，等待处理 | 橙色 |
| 已开具 | 发票已生成，可下载 | 蓝色 |
| 已发送 | 发票已发送到邮箱 | 绿色 |

---

## 四、电子车票展示

### 4.1 功能入口

**我的订单** → 订单详情 → 车票列表 → **电子车票** 按钮

**注意：** 只有已支付的订单才能查看电子车票

### 4.2 电子车票内容

1. **取票二维码**
   - 用于自助取票机取票
   - 或检票口扫码验票

2. **取票信息**
   - 取票号：车票唯一编码
   - 检票口：登车检票位置
   - 检票开始时间：提前检票时间

3. **乘车信息**
   - 车次号
   - 出发站、到达站
   - 出发时间、到达时间
   - 座位号
   - 票价

4. **乘客信息**
   - 姓名
   - 证件号（脱敏显示）

5. **乘车须知**
   - 重要提示和注意事项

### 4.3 操作功能

- **下载行程单**：生成PDF格式行程单
- **打印车票**：直接打印电子车票

---

## 五、管理后台调整

### 5.1 车次管理页面

**调整内容：**
- 移除了座位信息列
- 移除了票价信息列
- 专注于车次基本信息管理

**保留功能：**
- 车次号、车型
- 线路（出发站→到达站）
- 日期
- 时间段、历时
- 添加、编辑、删除车次

### 5.2 票价管理页面

**新增内容：**
- 添加了座位信息列
  - 可售座位数（绿色显示）
  - 总座位数

**功能说明：**
- 集中管理票价和座位信息
- 直观显示座位库存状态
- 支持快速修改票价

---

## 六、前端组件说明

### 6.1 新增组件

1. **PassengerManagement** - 常用联系人管理
   - 位置：`src/pages/Profile/components/PassengerManagement.jsx`
   - 功能：增删改查常用联系人

2. **InvoiceManagement** - 发票管理
   - 位置：`src/pages/Profile/components/InvoiceManagement.jsx`
   - 包含：发票记录列表、发票抬头管理

3. **ETicketDetail** - 电子车票详情
   - 位置：`src/components/ETicketDetail/index.jsx`
   - 功能：展示电子车票、二维码、取票信息

### 6.2 新增API接口

1. **常用联系人API** - `src/api/passenger.js`
   ```javascript
   getPassengerList()        // 获取联系人列表
   createPassenger(data)     // 创建联系人
   updatePassenger(id, data) // 更新联系人
   deletePassenger(id)       // 删除联系人
   getDefaultPassenger()     // 获取默认联系人
   ```

2. **发票API** - `src/api/invoice.js`
   ```javascript
   getInvoiceList()             // 获取发票列表
   applyInvoice(data)           // 申请发票
   downloadInvoice(id)          // 下载发票
   getInvoiceTitleList()        // 获取抬头列表
   createInvoiceTitle(data)     // 创建抬头
   updateInvoiceTitle(id, data) // 更新抬头
   deleteInvoiceTitle(id)       // 删除抬头
   ```

---

## 七、后端开发说明

### 7.1 需要实现的Controller

1. **PassengerController**
   ```
   GET    /api/passengers          - 获取常用联系人列表
   POST   /api/passengers          - 创建常用联系人
   PUT    /api/passengers/{id}     - 更新常用联系人
   DELETE /api/passengers/{id}     - 删除常用联系人
   GET    /api/passengers/default  - 获取默认联系人
   ```

2. **InvoiceController**
   ```
   GET    /api/invoices               - 获取发票列表
   POST   /api/invoices/apply         - 申请发票
   GET    /api/invoices/{id}/download - 下载发票
   
   GET    /api/invoice-titles         - 获取抬头列表
   POST   /api/invoice-titles         - 创建抬头
   PUT    /api/invoice-titles/{id}    - 更新抬头
   DELETE /api/invoice-titles/{id}    - 删除抬头
   ```

3. **TicketController 增强**
   ```
   GET /api/tickets/{id}/qrcode - 生成取票二维码
   ```

### 7.2 Service层建议

1. **PassengerService**
   - 验证证件号格式
   - 同一用户同一证件号不能重复
   - 软删除机制

2. **InvoiceService**
   - 验证订单是否存在且已支付
   - 同一订单可多次申请发票
   - 发票号自动生成
   - 集成PDF生成服务
   - 集成邮件发送服务

3. **TicketService 增强**
   - 生成唯一取票号
   - 生成二维码URL
   - 分配检票口
   - 计算检票开始时间

---

## 八、测试建议

### 8.1 常用联系人测试

1. 添加多个联系人
2. 设置默认联系人
3. 编辑联系人信息
4. 删除联系人
5. 验证证件号唯一性

### 8.2 发票测试

1. 申请个人发票
2. 申请企业发票
3. 管理发票抬头
4. 下载发票PDF
5. 验证订单状态

### 8.3 电子车票测试

1. 查看已支付订单的电子车票
2. 验证二维码生成
3. 测试打印功能
4. 测试下载行程单
5. 验证信息完整性

---

## 九、注意事项

### 9.1 数据库

- 确保先执行扩展脚本再启动后端
- 建议备份现有数据后再执行
- 检查外键约束是否正常

### 9.2 前端

- 所有新组件使用极简设计风格
- 保持与现有页面风格一致
- 响应式布局支持

### 9.3 后端

- API接口需要登录认证
- 数据权限校验（用户只能管理自己的数据）
- 错误处理和异常提示
- 日志记录

---

## 十、未来扩展

### 10.1 可能的增强

1. **常用联系人**
   - 导入/导出联系人
   - 联系人分组
   - 批量操作

2. **发票**
   - 发票历史记录
   - 发票统计分析
   - 自动开票

3. **电子车票**
   - 短信通知
   - 微信/支付宝推送
   - 添加到钱包

4. **座位选择**
   - 可视化选座
   - 座位偏好设置
   - 自动推荐座位

---

## 联系方式

如有问题，请参考：
- 系统概览：`SYSTEM_OVERVIEW_README.md`
- 项目结构：`PROJECT_STRUCTURE.md`
- 启动指南：`STARTUP_GUIDE.md`
